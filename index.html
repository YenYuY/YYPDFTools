<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ¨™é¡Œå·²æ›´æ–°ç‚º 3Yå·¥å…·ç®± -->
    <title data-i18n="site_title">3Yå·¥å…·ç®± | æœ¬åœ°ç«¯å®‰å…¨è™•ç†</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>

    <style>
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-btn {
            white-space: nowrap;
            padding: 1rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .tab-btn.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 700;
        }
        .tab-btn:hover:not(.active) {
            color: #374151;
            background-color: #f9fafb;
        }
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .dragging {
            opacity: 0.5;
            background-color: #e5e7eb;
            border: 2px dashed #9ca3af;
        }
        .drag-over {
            border-top: 3px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- å°è¦½åˆ— -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex h-16 items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    <!-- LOGOæ–‡å­—å·²æ›´æ–° -->
                    <span class="font-bold text-xl tracking-tight hidden sm:block" data-i18n="nav_title">3Yå·¥å…·ç®±</span>
                </div>

                <!-- å³å´é¸å–® (èªè¨€ + é—œæ–¼) -->
                <div class="flex items-center gap-3">
                    <button onclick="openAboutModal()" class="text-sm font-medium text-gray-600 hover:text-blue-600 flex items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span data-i18n="nav_about">é—œæ–¼æœ¬ç«™</span>
                    </button>
                    
                    <select id="lang-selector" onchange="changeLanguage(this.value)" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 py-1 pl-2 pr-6">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- æ©«å‘æ»¾å‹•é¸å–® -->
    <div class="bg-white border-b shadow-sm">
        <div class="max-w-6xl mx-auto px-2">
            <div class="flex overflow-x-auto hide-scrollbar gap-2" id="tab-container">
                <button onclick="switchTab('img')" class="tab-btn active" id="btn-tab-img" data-i18n="tab_img">PDF è½‰åœ–ç‰‡</button>
                <button onclick="switchTab('merge')" class="tab-btn" id="btn-tab-merge" data-i18n="tab_merge">PDF åˆä½µ</button>
                <button onclick="switchTab('split')" class="tab-btn" id="btn-tab-split" data-i18n="tab_split">PDF åˆ†å‰²</button>
                <button onclick="switchTab('compress')" class="tab-btn" id="btn-tab-compress" data-i18n="tab_compress">PDF å£“ç¸®</button>
                <button onclick="switchTab('protect')" class="tab-btn" id="btn-tab-protect" data-i18n="tab_protect">PDF åŠ å¯†/è§£é–</button>
                <button onclick="switchTab('rotate')" class="tab-btn" id="btn-tab-rotate" data-i18n="tab_rotate">PDF æ—‹è½‰</button>
                <button onclick="switchTab('heic')" class="tab-btn text-purple-600" id="btn-tab-heic" data-i18n="tab_heic">HEIC è½‰ JPG</button>
                <button onclick="switchTab('toai')" class="tab-btn text-orange-600" id="btn-tab-toai" data-i18n="tab_toai">JPG/PNG è½‰ aiæª”æ¡ˆ(è©¦ç”¨)</button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-4xl mx-auto px-4 py-8 flex-grow w-full">

        <!-- 1. PDF è½‰åœ–ç‰‡ -->
        <section id="sec-img" class="block">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold" data-i18n="title_img">PDF è½‰ JPG/PNG</h2>
                <p class="text-gray-500" data-i18n="desc_img">å°‡æ¯ä¸€é  PDF è½‰æ›ç‚ºåœ–ç‰‡ä¸¦æ‰“åŒ…ä¸‹è¼‰</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <input type="file" id="file-img" class="hidden" accept="application/pdf">
                <div onclick="document.getElementById('file-img').click()" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition">
                    <p class="text-lg text-gray-600 font-medium" data-i18n="drop_pdf">é»æ“Šä¸Šå‚³ PDF</p>
                </div>
                <div id="ctrl-img" class="hidden mt-4 pt-4 border-t">
                    <p id="name-img" class="mb-2 font-bold text-gray-700"></p>
                    <div class="flex gap-2">
                        <select id="fmt-img" class="border rounded px-2 py-2"><option value="jpeg">JPG</option><option value="png">PNG</option></select>
                        <button id="do-img" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full" data-i18n="btn_convert">é–‹å§‹è½‰æ›</button>
                    </div>
                    <div id="prog-img" class="hidden mt-2 text-sm text-blue-600" data-i18n="processing">è™•ç†ä¸­...</div>
                </div>
            </div>
        </section>

        <!-- 2. PDF åˆä½µ (æ”¯æ´æ‹–æ›³æ’åº) -->
        <section id="sec-merge" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold" data-i18n="title_merge">PDF åˆä½µ</h2>
                <p class="text-gray-500" data-i18n="desc_merge">å°‡å¤šå€‹ PDF ä¸²æ¥æˆä¸€å€‹æª”æ¡ˆï¼Œå¯æ‹–æ›³èª¿æ•´é †åº</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <input type="file" id="file-merge" class="hidden" accept="application/pdf" multiple>
                <div onclick="document.getElementById('file-merge').click()" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition">
                    <p class="text-lg text-gray-600 font-medium" data-i18n="drop_pdfs">é»æ“Šé¸æ“‡å¤šå€‹ PDF</p>
                </div>
                
                <!-- æ‹–æ›³åˆ—è¡¨å€ -->
                <div id="merge-container" class="mt-6 hidden">
                    <p class="text-sm text-gray-500 mb-2 italic text-center" data-i18n="drag_hint">ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥æ‹–æ›³ä¸‹æ–¹çš„é …ç›®ä¾†èª¿æ•´åˆä½µé †åº</p>
                    <ul id="list-merge" class="space-y-2">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </ul>
                    <button id="do-merge" class="mt-6 w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 font-bold" data-i18n="btn_merge_dl">åˆä½µä¸¦ä¸‹è¼‰</button>
                </div>
            </div>
        </section>

        <!-- 3. PDF åˆ†å‰² -->
        <section id="sec-split" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold" data-i18n="title_split">PDF åˆ†å‰²</h2>
                <p class="text-gray-500" data-i18n="desc_split">æå–æŒ‡å®šç¯„åœçš„é é¢å­˜ç‚ºæ–° PDF</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <input type="file" id="file-split" class="hidden" accept="application/pdf">
                <div onclick="document.getElementById('file-split').click()" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition">
                    <p class="text-lg text-gray-600 font-medium" data-i18n="drop_pdf">é»æ“Šä¸Šå‚³ PDF</p>
                </div>
                <div id="ctrl-split" class="hidden mt-4 pt-4 border-t">
                    <p id="name-split" class="mb-4 font-bold text-gray-700"></p>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="lbl_start_page">èµ·å§‹é </label>
                            <input type="number" id="split-start" min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-md border p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="lbl_end_page">çµæŸé </label>
                            <input type="number" id="split-end" min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-md border p-2">
                        </div>
                    </div>
                    <button id="do-split" class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 font-bold" data-i18n="btn_split_dl">åˆ†å‰²ä¸¦ä¸‹è¼‰</button>
                </div>
            </div>
        </section>

        <!-- 4. PDF å£“ç¸® (æ–°åŠŸèƒ½) -->
        <section id="sec-compress" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold" data-i18n="title_compress">PDF å£“ç¸® (é‡è£½)</h2>
                <p class="text-gray-500" data-i18n="desc_compress">é€éå°‡ PDF è½‰ç‚ºåœ–ç‰‡å†é‡å»ºä¾†æ¸›å°‘æª”æ¡ˆå¤§å°</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <input type="file" id="file-compress" class="hidden" accept="application/pdf">
                <div onclick="document.getElementById('file-compress').click()" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-green-50 hover:border-green-400 transition">
                    <p class="text-lg text-gray-600 font-medium" data-i18n="drop_pdf">é»æ“Šä¸Šå‚³ PDF</p>
                </div>
                <div id="ctrl-compress" class="hidden mt-4 pt-4 border-t">
                    <p id="name-compress" class="mb-4 font-bold text-gray-700"></p>
                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded mb-4 text-sm text-yellow-800">
                        <strong data-i18n="note_title">æ³¨æ„ï¼š</strong> <span data-i18n="note_compress">æ­¤æ¨¡å¼æœƒå°‡æ‰€æœ‰é é¢è½‰ç‚ºåœ–ç‰‡ã€‚æ–‡å­—å°‡ç„¡æ³•é¸å–ï¼Œä½†å¯å¤§å¹…æ¸›å°‘æƒææª”çš„å¤§å°ã€‚</span>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="lbl_quality">åœ–ç‰‡å“è³ª (è¶Šä½æª”æ¡ˆè¶Šå°)</label>
                        <select id="compress-quality" class="w-full border rounded p-2">
                            <option value="0.5">ä½ç•«è³ª (é«˜å£“ç¸®)</option>
                            <option value="0.7" selected>ä¸­ç•«è³ª (æ¨è–¦)</option>
                            <option value="0.9">é«˜ç•«è³ª (è¼•å¾®å£“ç¸®)</option>
                        </select>
                    </div>
                    <button id="do-compress" class="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700 font-bold" data-i18n="btn_compress_dl">é–‹å§‹å£“ç¸®ä¸¦ä¸‹è¼‰</button>
                    <div id="prog-compress" class="hidden mt-2 text-center text-sm text-green-600">0%</div>
                </div>
            </div>
        </section>

        <!-- 5. PDF åŠ å¯†/è§£é– (æ–°åŠŸèƒ½) -->
        <section id="sec-protect" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold" data-i18n="title_protect">PDF åŠ å¯†èˆ‡è§£é–</h2>
                <p class="text-gray-500" data-i18n="desc_protect">ç‚ºæ–‡ä»¶è¨­å®šå¯†ç¢¼ï¼Œæˆ–ç§»é™¤å·²çŸ¥å¯†ç¢¼</p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- åŠ å¯†å€ -->
                <div class="bg-white rounded-xl shadow p-6 border-t-4 border-blue-500">
                    <h3 class="font-bold text-lg mb-4" data-i18n="subtitle_encrypt">åŠ å¯† (è¨­å®šå¯†ç¢¼)</h3>
                    <input type="file" id="file-encrypt" class="hidden" accept="application/pdf">
                    <button onclick="document.getElementById('file-encrypt').click()" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 mb-4">
                        <span id="name-encrypt" class="text-gray-600 block truncate" data-i18n="select_file">é¸æ“‡æª”æ¡ˆ</span>
                    </button>
                    <input type="password" id="pass-encrypt" class="w-full border rounded p-2 mb-4" placeholder="è¨­å®šå¯†ç¢¼" data-i18n="ph_set_pass">
                    <button id="do-encrypt" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-i18n="btn_encrypt">ä¸‹è¼‰åŠ å¯†æª”æ¡ˆ</button>
                </div>

                <!-- è§£é–å€ -->
                <div class="bg-white rounded-xl shadow p-6 border-t-4 border-red-500">
                    <h3 class="font-bold text-lg mb-4" data-i18n="subtitle_unlock">è§£é– (ç§»é™¤å¯†ç¢¼)</h3>
                    <input type="file" id="file-unlock" class="hidden" accept="application/pdf">
                    <button onclick="document.getElementById('file-unlock').click()" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 mb-4">
                        <span id="name-unlock" class="text-gray-600 block truncate" data-i18n="select_file">é¸æ“‡æª”æ¡ˆ</span>
                    </button>
                    <input type="password" id="pass-unlock" class="w-full border rounded p-2 mb-4" placeholder="è¼¸å…¥åŸå§‹å¯†ç¢¼" data-i18n="ph_org_pass">
                    <button id="do-unlock" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700" data-i18n="btn_unlock">ä¸‹è¼‰è§£é–æª”æ¡ˆ</button>
                </div>
            </div>
        </section>

        <!-- 6. PDF æ—‹è½‰ -->
        <section id="sec-rotate" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold" data-i18n="title_rotate">PDF é é¢æ—‹è½‰</h2>
                <p class="text-gray-500" data-i18n="desc_rotate">å°‡ PDF æ‰€æœ‰é é¢é€²è¡Œæ—‹è½‰</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6">
                <input type="file" id="file-rotate" class="hidden" accept="application/pdf">
                <div onclick="document.getElementById('file-rotate').click()" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition">
                    <p class="text-lg text-gray-600 font-medium" data-i18n="drop_pdf">é»æ“Šä¸Šå‚³ PDF</p>
                </div>
                <div id="ctrl-rotate" class="hidden mt-4 pt-4 border-t">
                    <p id="name-rotate" class="mb-4 font-bold text-gray-700"></p>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="lbl_rotate_deg">é¸æ“‡æ—‹è½‰è§’åº¦ (é †æ™‚é‡)</label>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="setRotate(90)" class="rotate-opt bg-gray-100 hover:bg-gray-200 py-2 rounded border border-gray-200" data-deg="90">90Â°</button>
                        <button onclick="setRotate(180)" class="rotate-opt bg-gray-100 hover:bg-gray-200 py-2 rounded border border-gray-200" data-deg="180">180Â°</button>
                        <button onclick="setRotate(270)" class="rotate-opt bg-gray-100 hover:bg-gray-200 py-2 rounded border border-gray-200" data-deg="270">270Â°</button>
                    </div>
                    <button id="do-rotate" class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 font-bold" data-i18n="btn_rotate_dl">æ—‹è½‰ä¸¦ä¸‹è¼‰</button>
                </div>
            </div>
        </section>

        <!-- 7. HEIC è½‰ JPG -->
        <section id="sec-heic" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-purple-700" data-i18n="title_heic">HEIC è½‰ JPG</h2>
                <p class="text-gray-500" data-i18n="desc_heic">iPhone ç…§ç‰‡æ ¼å¼è½‰æ›ç‚ºé€šç”¨ JPG</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 border-t-4 border-purple-500">
                <input type="file" id="file-heic" class="hidden" accept=".heic, .heif">
                <div onclick="document.getElementById('file-heic').click()" class="border-2 border-dashed border-purple-200 bg-purple-50 rounded-lg p-8 text-center cursor-pointer hover:bg-purple-100 transition">
                    <div class="flex flex-col items-center">
                        <svg class="w-10 h-10 text-purple-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="text-lg text-purple-900 font-medium" data-i18n="drop_heic">é»æ“Šä¸Šå‚³ HEIC æª”æ¡ˆ</p>
                    </div>
                </div>
                <div id="res-heic" class="hidden mt-6 text-center">
                    <p id="status-heic" class="text-sm font-bold text-gray-700 mb-2" data-i18n="processing">è½‰æ›ä¸­...</p>
                    <img id="preview-heic" class="max-w-full h-auto rounded shadow mx-auto mb-4" style="max-height: 300px;">
                    <button id="dl-heic" class="bg-green-600 text-white px-6 py-2 rounded shadow hover:bg-green-700" data-i18n="btn_dl_jpg">ä¸‹è¼‰ JPG</button>
                </div>
            </div>
        </section>

        <!-- 8. JPG/PNG è½‰ AI (è©¦ç”¨) -->
        <section id="sec-toai" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-orange-700" data-i18n="title_toai">JPG/PNG è½‰ aiæª”æ¡ˆ(è©¦ç”¨)</h2>
                <p class="text-gray-500" data-i18n="desc_toai">å°‡åœ–ç‰‡è½‰æ›ç‚º Adobe Illustrator ç›¸å®¹æª”æ¡ˆ (.ai)</p>
            </div>
            <div class="bg-white rounded-xl shadow p-6 border-t-4 border-orange-500">
                <input type="file" id="file-toai" class="hidden" accept="image/jpeg, image/png">
                <div onclick="document.getElementById('file-toai').click()" class="border-2 border-dashed border-orange-200 bg-orange-50 rounded-lg p-8 text-center cursor-pointer hover:bg-orange-100 transition">
                    <div class="flex flex-col items-center">
                        <svg class="w-10 h-10 text-orange-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="text-lg text-orange-900 font-medium" data-i18n="drop_img">é»æ“Šä¸Šå‚³ JPG æˆ– PNG åœ–ç‰‡</p>
                    </div>
                </div>
                
                <div id="ctrl-toai" class="hidden mt-6 pt-4 border-t text-center">
                    <p id="name-toai" class="mb-4 font-bold text-gray-700"></p>
                    <p class="text-sm text-gray-500 mb-4 bg-yellow-50 p-2 rounded border border-yellow-200" data-i18n="note_toai">
                        æ³¨æ„ï¼šæ­¤åŠŸèƒ½æœƒå°‡åœ–ç‰‡åµŒå…¥åˆ° AI æª”ä¸­ï¼Œä¸¦éè½‰ç‚ºå‘é‡ç·šæ¢ã€‚ä½†æ‚¨å¯ä»¥ç›´æ¥ç”¨ Illustrator é–‹å•Ÿç·¨è¼¯ã€‚
                    </p>
                    <button id="do-toai" class="w-full sm:w-auto bg-orange-600 text-white px-8 py-3 rounded shadow hover:bg-orange-700 font-bold" data-i18n="btn_toai_dl">è½‰æ›ä¸¦ä¸‹è¼‰ .AI</button>
                </div>
            </div>
        </section>

    </main>

    <!-- é—œæ–¼æœ¬ç«™ Modal -->
    <div id="about-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-900 mb-4" data-i18n="about_title">é—œæ–¼æœ¬ç«™</h3>
                <div class="mt-2 px-2 py-3">
                    <p class="text-sm text-gray-500 text-left leading-relaxed bg-gray-50 p-3 rounded" data-i18n="about_content">
                        å…§å®¹...
                    </p>
                </div>
                <div class="mb-4">
                    <a href="https://github.com/YenYuY/YYPDFTools" target="_blank" class="inline-flex items-center justify-center gap-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 w-full transition">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" /></svg>
                        <span data-i18n="github_btn">å‰å¾€ GitHub å°ˆæ¡ˆ</span>
                    </a>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="document.getElementById('about-modal').classList.add('hidden')" class="px-4 py-2 bg-blue-500 text-white font-medium rounded-md w-full hover:bg-blue-700" data-i18n="btn_close">
                        äº†è§£ï¼Œé—œé–‰è¦–çª—
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-white border-t py-6 text-center text-gray-400 text-sm">
        &copy; 2025 3Y Tools.
    </footer>

    <!-- é‚è¼¯è…³æœ¬ -->
    <script>
        // === å¤šèªè¨€å­—å…¸ (å·²æ›´æ–°ç‚º 3Yå·¥å…·ç®±) ===
        const translations = {
            "zh-TW": {
                site_title: "3Yå·¥å…·ç®± | æœ¬åœ°ç«¯å®‰å…¨è™•ç†",
                nav_title: "3Yå·¥å…·ç®±",
                nav_about: "é—œæ–¼æœ¬ç«™",
                tab_img: "PDF è½‰åœ–ç‰‡",
                tab_merge: "PDF åˆä½µ",
                tab_split: "PDF åˆ†å‰²",
                tab_compress: "PDF å£“ç¸®",
                tab_protect: "åŠ å¯†/è§£é–",
                tab_rotate: "PDF æ—‹è½‰",
                tab_heic: "HEIC è½‰ JPG",
                tab_toai: "JPG/PNG è½‰ aiæª”æ¡ˆ(è©¦ç”¨)",
                // Common
                processing: "è™•ç†ä¸­...",
                drop_pdf: "é»æ“Šä¸Šå‚³ PDF",
                select_file: "é¸æ“‡æª”æ¡ˆ",
                // PDF to IMG
                title_img: "PDF è½‰ JPG/PNG",
                desc_img: "å°‡æ¯ä¸€é  PDF è½‰æ›ç‚ºåœ–ç‰‡ä¸¦æ‰“åŒ…ä¸‹è¼‰",
                btn_convert: "é–‹å§‹è½‰æ›",
                // Merge
                title_merge: "PDF åˆä½µ",
                desc_merge: "å°‡å¤šå€‹ PDF ä¸²æ¥æˆä¸€å€‹æª”æ¡ˆï¼Œå¯æ‹–æ›³èª¿æ•´é †åº",
                drop_pdfs: "é»æ“Šé¸æ“‡å¤šå€‹ PDF",
                drag_hint: "ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥æ‹–æ›³ä¸‹æ–¹çš„é …ç›®ä¾†èª¿æ•´åˆä½µé †åº",
                btn_merge_dl: "åˆä½µä¸¦ä¸‹è¼‰",
                // Split
                title_split: "PDF åˆ†å‰²",
                desc_split: "æå–æŒ‡å®šç¯„åœçš„é é¢å­˜ç‚ºæ–° PDF",
                lbl_start_page: "èµ·å§‹é ",
                lbl_end_page: "çµæŸé ",
                btn_split_dl: "åˆ†å‰²ä¸¦ä¸‹è¼‰",
                // Compress
                title_compress: "PDF å£“ç¸® (é‡è£½)",
                desc_compress: "é€éå°‡ PDF è½‰ç‚ºåœ–ç‰‡å†é‡å»ºä¾†æ¸›å°‘æª”æ¡ˆå¤§å°",
                note_title: "æ³¨æ„ï¼š",
                note_compress: "æ­¤æ¨¡å¼æœƒå°‡æ‰€æœ‰é é¢è½‰ç‚ºåœ–ç‰‡ã€‚æ–‡å­—å°‡ç„¡æ³•é¸å–ï¼Œä½†å¯å¤§å¹…æ¸›å°‘æƒææª”çš„å¤§å°ã€‚",
                lbl_quality: "åœ–ç‰‡å“è³ª (è¶Šä½æª”æ¡ˆè¶Šå°)",
                btn_compress_dl: "é–‹å§‹å£“ç¸®ä¸¦ä¸‹è¼‰",
                // Protect
                title_protect: "PDF åŠ å¯†èˆ‡è§£é–",
                desc_protect: "ç‚ºæ–‡ä»¶è¨­å®šå¯†ç¢¼ï¼Œæˆ–ç§»é™¤å·²çŸ¥å¯†ç¢¼",
                subtitle_encrypt: "åŠ å¯† (è¨­å®šå¯†ç¢¼)",
                ph_set_pass: "è¨­å®šå¯†ç¢¼",
                btn_encrypt: "ä¸‹è¼‰åŠ å¯†æª”æ¡ˆ",
                subtitle_unlock: "è§£é– (ç§»é™¤å¯†ç¢¼)",
                ph_org_pass: "è¼¸å…¥åŸå§‹å¯†ç¢¼",
                btn_unlock: "ä¸‹è¼‰è§£é–æª”æ¡ˆ",
                // Rotate
                title_rotate: "PDF é é¢æ—‹è½‰",
                desc_rotate: "å°‡ PDF æ‰€æœ‰é é¢é€²è¡Œæ—‹è½‰",
                lbl_rotate_deg: "é¸æ“‡æ—‹è½‰è§’åº¦ (é †æ™‚é‡)",
                btn_rotate_dl: "æ—‹è½‰ä¸¦ä¸‹è¼‰",
                // HEIC
                title_heic: "HEIC è½‰ JPG",
                desc_heic: "iPhone ç…§ç‰‡æ ¼å¼è½‰æ›ç‚ºé€šç”¨ JPG",
                drop_heic: "é»æ“Šä¸Šå‚³ HEIC æª”æ¡ˆ",
                btn_dl_jpg: "ä¸‹è¼‰ JPG",
                // IMG to AI
                title_toai: "JPG/PNG è½‰ aiæª”æ¡ˆ(è©¦ç”¨)",
                desc_toai: "å°‡åœ–ç‰‡è½‰æ›ç‚º Adobe Illustrator ç›¸å®¹æª”æ¡ˆ (.ai)",
                drop_img: "é»æ“Šä¸Šå‚³ JPG æˆ– PNG åœ–ç‰‡",
                note_toai: "æ³¨æ„ï¼šæ­¤åŠŸèƒ½æœƒå°‡åœ–ç‰‡åµŒå…¥åˆ° AI æª”ä¸­ï¼Œä¸¦éè½‰ç‚ºå‘é‡ç·šæ¢ã€‚ä½†æ‚¨å¯ä»¥ç›´æ¥ç”¨ Illustrator é–‹å•Ÿç·¨è¼¯ã€‚",
                btn_toai_dl: "è½‰æ›ä¸¦ä¸‹è¼‰ .AI",
                // About
                about_title: "é—œæ–¼æœ¬ç«™",
                about_content: "æœ¬ç¶²ç«™çš„æ‰€æœ‰ PDF èˆ‡åœ–ç‰‡è™•ç†åŠŸèƒ½å‡å®Œå…¨åœ¨æ‚¨çš„ã€Œç€è¦½å™¨ç«¯ã€é‹è¡Œã€‚<br><br><strong>é€™æ„å‘³è‘—ï¼š</strong><br>1. æ‚¨çš„æª”æ¡ˆ<b>çµ•ä¸æœƒ</b>ä¸Šå‚³åˆ°æˆ‘å€‘çš„ä¼ºæœå™¨ã€‚<br>2. å³ä½¿æ²’æœ‰ç¶²è·¯ï¼Œé é¢è¼‰å…¥å¾Œä¾ç„¶å¯ä»¥ä½¿ç”¨ã€‚<br>3. æ‚¨çš„éš±ç§æ˜¯ 100% å®‰å…¨çš„ã€‚",
                github_btn: "å‰å¾€ GitHub å°ˆæ¡ˆ",
                btn_close: "äº†è§£ï¼Œé—œé–‰è¦–çª—"
            },
            "en": {
                site_title: "3Y Tools | Secure Local Processing",
                nav_title: "3Y Tools",
                nav_about: "About",
                tab_img: "PDF to Image",
                tab_merge: "Merge PDF",
                tab_split: "Split PDF",
                tab_compress: "Compress PDF",
                tab_protect: "Protect/Unlock",
                tab_rotate: "Rotate PDF",
                tab_heic: "HEIC to JPG",
                tab_toai: "JPG/PNG to .ai (Trial)",
                processing: "Processing...",
                drop_pdf: "Click to Upload PDF",
                select_file: "Select File",
                title_img: "PDF to JPG/PNG",
                desc_img: "Convert each PDF page to image",
                btn_convert: "Convert",
                title_merge: "Merge PDF",
                desc_merge: "Combine multiple PDFs into one, drag to reorder",
                drop_pdfs: "Click to Select Multiple PDFs",
                drag_hint: "ğŸ’¡ Tip: Drag items below to reorder",
                btn_merge_dl: "Merge & Download",
                title_split: "Split PDF",
                desc_split: "Extract pages to new PDF",
                lbl_start_page: "Start",
                lbl_end_page: "End",
                btn_split_dl: "Split & Download",
                title_compress: "Compress PDF (Rasterize)",
                desc_compress: "Reduce size by converting pages to images",
                note_title: "Note:",
                note_compress: "This converts pages to images. Text will not be selectable, but it reduces file size effectively for scans.",
                lbl_quality: "Image Quality (Lower = Smaller)",
                btn_compress_dl: "Compress & Download",
                title_protect: "Encrypt & Unlock",
                desc_protect: "Set password or remove password",
                subtitle_encrypt: "Encrypt (Set Password)",
                ph_set_pass: "Set Password",
                btn_encrypt: "Download Encrypted",
                subtitle_unlock: "Unlock (Remove Password)",
                ph_org_pass: "Enter Original Password",
                btn_unlock: "Download Unlocked",
                title_rotate: "Rotate PDF",
                desc_rotate: "Rotate all pages",
                lbl_rotate_deg: "Angle (Clockwise)",
                btn_rotate_dl: "Rotate & Download",
                title_heic: "HEIC to JPG",
                desc_heic: "Convert HEIC to JPG",
                drop_heic: "Click to Upload HEIC",
                btn_dl_jpg: "Download JPG",
                title_toai: "JPG/PNG to .ai (Trial)",
                desc_toai: "Convert image to .ai file",
                drop_img: "Click to Upload JPG/PNG",
                note_toai: "Note: Embeds image into AI file, not vectorization.",
                btn_toai_dl: "Convert & Download",
                about_title: "About",
                about_content: "All processing runs in your <b>Browser</b>.<br>Files are <b>NEVER</b> uploaded.",
                github_btn: "Visit GitHub",
                btn_close: "Close"
            },
            "ja": {
                site_title: "3Y ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹",
                nav_title: "3Y ãƒ„ãƒ¼ãƒ«",
                nav_about: "æƒ…å ±",
                tab_img: "PDF ç”»åƒå¤‰æ›",
                tab_merge: "PDF çµåˆ",
                tab_split: "PDF åˆ†å‰²",
                tab_compress: "PDF åœ§ç¸®",
                tab_protect: "æš—å·åŒ–/è§£é™¤",
                tab_rotate: "PDF å›è»¢",
                tab_heic: "HEIC JPG å¤‰æ›",
                tab_toai: "ç”»åƒ .ai å¤‰æ›(è©¦ç”¨)",
                processing: "å‡¦ç†ä¸­...",
                drop_pdf: "PDF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                select_file: "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ",
                title_img: "PDF ç”»åƒå¤‰æ›",
                desc_img: "å„ãƒšãƒ¼ã‚¸ã‚’ç”»åƒã«å¤‰æ›",
                btn_convert: "å¤‰æ›é–‹å§‹",
                title_merge: "PDF çµåˆ",
                desc_merge: "è¤‡æ•°ã®PDFã‚’çµåˆ (ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ)",
                drop_pdfs: "è¤‡æ•°ã® PDF ã‚’é¸æŠ",
                drag_hint: "ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼šãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †åºã‚’å¤‰æ›´ã§ãã¾ã™",
                btn_merge_dl: "çµåˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                title_split: "PDF åˆ†å‰²",
                desc_split: "æŒ‡å®šç¯„å›²ã‚’æŠ½å‡º",
                lbl_start_page: "é–‹å§‹",
                lbl_end_page: "çµ‚äº†",
                btn_split_dl: "åˆ†å‰²ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                title_compress: "PDF åœ§ç¸® (ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚º)",
                desc_compress: "ç”»åƒã‚’å†æ§‹ç¯‰ã—ã¦ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›",
                note_title: "æ³¨æ„ï¼š",
                note_compress: "ãƒšãƒ¼ã‚¸å…¨ä½“ãŒç”»åƒåŒ–ã•ã‚Œã¾ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã¯ã§ãã¾ã›ã‚“ãŒã€ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åœ§ç¸®ã«æœ‰åŠ¹ã§ã™ã€‚",
                lbl_quality: "ç”»è³ª (ä½ã„ã»ã©è»½é‡)",
                btn_compress_dl: "åœ§ç¸®ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                title_protect: "æš—å·åŒ–ã¨è§£é™¤",
                desc_protect: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã¾ãŸã¯è§£é™¤",
                subtitle_encrypt: "æš—å·åŒ– (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š)",
                ph_set_pass: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š",
                btn_encrypt: "æš—å·åŒ–ã—ã¦DL",
                subtitle_unlock: "è§£é™¤ (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å‰Šé™¤)",
                ph_org_pass: "å…ƒã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›",
                btn_unlock: "è§£é™¤ã—ã¦DL",
                title_rotate: "PDF å›è»¢",
                desc_rotate: "å…¨ãƒšãƒ¼ã‚¸ã‚’å›è»¢",
                lbl_rotate_deg: "è§’åº¦ (æ™‚è¨ˆå›ã‚Š)",
                btn_rotate_dl: "å›è»¢ã—ã¦DL",
                title_heic: "HEIC JPG å¤‰æ›",
                desc_heic: "HEIC ã‚’ JPG ã«å¤‰æ›",
                drop_heic: "HEIC ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                btn_dl_jpg: "JPG DL",
                title_toai: "ç”»åƒ .ai å¤‰æ›(è©¦ç”¨)",
                desc_toai: "ç”»åƒã‚’ .ai å½¢å¼ã«å¤‰æ›",
                drop_img: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                note_toai: "æ³¨ï¼šç”»åƒã¯åŸ‹ã‚è¾¼ã¾ã‚Œã¾ã™ã€‚ãƒ™ã‚¯ã‚¿ãƒ¼åŒ–ã¯ã•ã‚Œã¾ã›ã‚“ã€‚",
                btn_toai_dl: "å¤‰æ›ã—ã¦DL",
                about_title: "ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦",
                about_content: "å‡¦ç†ã¯å…¨ã¦<b>ãƒ–ãƒ©ã‚¦ã‚¶ä¸Š</b>ã§è¡Œã‚ã‚Œã¾ã™ã€‚<br>ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
                github_btn: "GitHub ã¸",
                btn_close: "é–‰ã˜ã‚‹"
            }
        };

        let currentLang = 'zh-TW';
        function changeLanguage(lang) {
            currentLang = lang;
            document.getElementById('lang-selector').value = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    if (el.placeholder) el.placeholder = translations[lang][key];
                    else el.innerHTML = translations[lang][key];
                }
            });
        }
        window.addEventListener('load', () => {
            const l = navigator.language || navigator.userLanguage;
            if (l.startsWith('ja')) changeLanguage('ja');
            else if (l.startsWith('en')) changeLanguage('en');
            else changeLanguage('zh-TW');
        });
        function openAboutModal() { document.getElementById('about-modal').classList.remove('hidden'); }

        const tabs = ['img', 'merge', 'split', 'compress', 'protect', 'rotate', 'heic', 'toai'];
        function switchTab(t) {
            tabs.forEach(x => {
                document.getElementById(`sec-${x}`).classList.add('hidden');
                document.getElementById(`btn-tab-${x}`).classList.remove('active');
            });
            document.getElementById(`sec-${t}`).classList.remove('hidden');
            document.getElementById(`btn-tab-${t}`).classList.add('active');
        }

        // ================= åŠŸèƒ½é‚è¼¯ =================

        // 1. PDF è½‰åœ–ç‰‡
        let pdfImgFile = null;
        document.getElementById('file-img').addEventListener('change', e => {
            if(e.target.files[0]) {
                pdfImgFile = e.target.files[0];
                document.getElementById('name-img').textContent = pdfImgFile.name;
                document.getElementById('ctrl-img').classList.remove('hidden');
            }
        });
        document.getElementById('do-img').addEventListener('click', async () => {
            if(!pdfImgFile) return;
            const btn = document.getElementById('do-img');
            const prog = document.getElementById('prog-img');
            btn.disabled = true; btn.textContent = translations[currentLang]['processing'];
            prog.classList.remove('hidden');
            try {
                const pdf = await pdfjsLib.getDocument(await pdfImgFile.arrayBuffer()).promise;
                const zip = new JSZip();
                const fmt = document.getElementById('fmt-img').value;
                for(let i=1; i<=pdf.numPages; i++){
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale:2});
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
                    const blob = await new Promise(r=>canvas.toBlob(r, `image/${fmt}`, 0.8));
                    zip.file(`page_${i}.${fmt==='jpeg'?'jpg':'png'}`, blob);
                    prog.textContent = `${Math.round(i/pdf.numPages*100)}%`;
                }
                saveAs(await zip.generateAsync({type:"blob"}), `${pdfImgFile.name}_images.zip`);
            } catch(e){ alert(e.message); }
            finally { btn.disabled=false; btn.textContent=translations[currentLang]['btn_convert']; prog.classList.add('hidden'); }
        });

        // 2. PDF åˆä½µ (å«æ‹–æ›³æ’åº)
        let mergeFiles = [];
        const mergeContainer = document.getElementById('merge-container');
        const listMerge = document.getElementById('list-merge');

        document.getElementById('file-merge').addEventListener('change', e => {
            if(e.target.files.length) {
                mergeFiles = [...mergeFiles, ...Array.from(e.target.files)];
                renderMergeList();
            }
        });

        function renderMergeList() {
            if (mergeFiles.length > 0) mergeContainer.classList.remove('hidden');
            else mergeContainer.classList.add('hidden');

            listMerge.innerHTML = '';
            mergeFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded border cursor-move select-none';
                li.draggable = true;
                li.dataset.index = index;
                li.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="text-gray-400">â˜°</span>
                        <span class="truncate text-sm font-medium">${index + 1}. ${file.name}</span>
                    </div>
                    <button onclick="removeMerge(${index})" class="text-red-500 hover:text-red-700 font-bold px-2">âœ•</button>
                `;
                
                // æ‹–æ›³äº‹ä»¶
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragenter', handleDragEnter);
                li.addEventListener('dragleave', handleDragLeave);

                listMerge.appendChild(li);
            });
        }

        window.removeMerge = (i) => {
            mergeFiles.splice(i, 1);
            renderMergeList();
        };

        // æ‹–æ›³é‚è¼¯
        let dragSrcIndex = null;
        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcIndex = Number(this.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            return false;
        }
        function handleDragEnter(e) { this.classList.add('drag-over'); }
        function handleDragLeave(e) { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.stopPropagation();
            this.classList.remove('drag-over');
            const dragTargetIndex = Number(this.dataset.index);
            if (dragSrcIndex !== dragTargetIndex) {
                const item = mergeFiles[dragSrcIndex];
                mergeFiles.splice(dragSrcIndex, 1);
                mergeFiles.splice(dragTargetIndex, 0, item);
                renderMergeList();
            }
            return false;
        }

        document.getElementById('do-merge').addEventListener('click', async () => {
            if(mergeFiles.length < 2) return alert("Please select at least 2 files");
            const btn = document.getElementById('do-merge');
            btn.textContent = translations[currentLang]['processing'];
            try {
                const { PDFDocument } = PDFLib;
                const merged = await PDFDocument.create();
                for (let file of mergeFiles) {
                    const src = await PDFDocument.load(await file.arrayBuffer());
                    const pages = await merged.copyPages(src, src.getPageIndices());
                    pages.forEach(p => merged.addPage(p));
                }
                saveAs(new Blob([await merged.save()], {type:'application/pdf'}), 'merged.pdf');
            } catch(e) { alert("Merge failed: " + e.message); }
            finally { btn.textContent = translations[currentLang]['btn_merge_dl']; }
        });

        // 3. Split
        let splitFile, splitPdfDoc;
        document.getElementById('file-split').addEventListener('change', async e => {
            if(e.target.files[0]) {
                splitFile = e.target.files[0];
                document.getElementById('name-split').textContent = splitFile.name;
                const arr = await splitFile.arrayBuffer();
                splitPdfDoc = await PDFLib.PDFDocument.load(arr);
                const count = splitPdfDoc.getPageCount();
                document.getElementById('split-end').value = count;
                document.getElementById('split-end').max = count;
                document.getElementById('split-start').max = count;
                document.getElementById('ctrl-split').classList.remove('hidden');
            }
        });
        document.getElementById('do-split').addEventListener('click', async () => {
            if(!splitFile) return;
            const start = parseInt(document.getElementById('split-start').value)-1;
            const end = parseInt(document.getElementById('split-end').value)-1;
            try {
                const { PDFDocument } = PDFLib;
                const newPdf = await PDFDocument.create();
                const indices = []; for(let i=start; i<=end; i++) indices.push(i);
                const pages = await newPdf.copyPages(splitPdfDoc, indices);
                pages.forEach(p=>newPdf.addPage(p));
                saveAs(new Blob([await newPdf.save()],{type:'application/pdf'}), `split.pdf`);
            } catch(e){ alert(e.message); }
        });

        // 4. Compress (Rasterize)
        let compressFile = null;
        document.getElementById('file-compress').addEventListener('change', e => {
            if(e.target.files[0]){
                compressFile = e.target.files[0];
                document.getElementById('name-compress').textContent = compressFile.name;
                document.getElementById('ctrl-compress').classList.remove('hidden');
            }
        });
        document.getElementById('do-compress').addEventListener('click', async () => {
            if(!compressFile) return;
            const btn = document.getElementById('do-compress');
            const prog = document.getElementById('prog-compress');
            const quality = parseFloat(document.getElementById('compress-quality').value);
            
            btn.disabled = true; btn.textContent = translations[currentLang]['processing'];
            prog.classList.remove('hidden');

            try {
                // 1. Load Original
                const pdfData = await compressFile.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument(pdfData);
                const pdf = await loadingTask.promise;
                const { PDFDocument } = PDFLib;
                const newPdf = await PDFDocument.create();

                // 2. Loop Pages -> Canvas -> JPG -> New PDF
                for(let i=1; i<=pdf.numPages; i++){
                    const page = await pdf.getPage(i);
                    // ä½¿ç”¨ 1.5 å€ç¸®æ”¾ä¿æŒå¯è®€æ€§ï¼Œä½†ä¸è¦å¤ªå¤§
                    const scale = 1.5; 
                    const viewport = page.getViewport({scale: scale});
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    
                    await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                    
                    // è½‰ç‚º JPEG blob
                    const imgDataUrl = canvas.toDataURL('image/jpeg', quality);
                    const imgBytes = await fetch(imgDataUrl).then(res => res.arrayBuffer());
                    
                    const jpgImage = await newPdf.embedJpg(imgBytes);
                    const newPage = newPdf.addPage([viewport.width/scale, viewport.height/scale]); // é‚„åŸåŸå§‹å°ºå¯¸å–®ä½
                    newPage.drawImage(jpgImage, {
                        x: 0, y: 0,
                        width: viewport.width/scale,
                        height: viewport.height/scale
                    });
                    
                    prog.textContent = `Page ${i}/${pdf.numPages}`;
                }
                
                const pdfBytes = await newPdf.save();
                saveAs(new Blob([pdfBytes], {type: 'application/pdf'}), `compressed_${compressFile.name}`);

            } catch(e){ console.error(e); alert("Compress Error: " + e.message); }
            finally { btn.disabled=false; btn.textContent=translations[currentLang]['btn_compress_dl']; prog.classList.add('hidden'); }
        });

        // 5. Protect (Encrypt/Unlock)
        // Encrypt
        let encryptFile = null;
        document.getElementById('file-encrypt').addEventListener('change', e => {
            if(e.target.files[0]) {
                encryptFile = e.target.files[0];
                document.getElementById('name-encrypt').textContent = encryptFile.name;
            }
        });
        document.getElementById('do-encrypt').addEventListener('click', async () => {
            if(!encryptFile) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
            const pwd = document.getElementById('pass-encrypt').value;
            if(!pwd) return alert('è«‹è¼¸å…¥å¯†ç¢¼');
            try {
                const { PDFDocument } = PDFLib;
                const pdf = await PDFDocument.load(await encryptFile.arrayBuffer());
                pdf.encrypt({ userPassword: pwd, ownerPassword: pwd });
                saveAs(new Blob([await pdf.save()], {type:'application/pdf'}), `encrypted_${encryptFile.name}`);
            } catch(e){ alert(e.message); }
        });
        
        // Unlock
        let unlockFile = null;
        document.getElementById('file-unlock').addEventListener('change', e => {
            if(e.target.files[0]) {
                unlockFile = e.target.files[0];
                document.getElementById('name-unlock').textContent = unlockFile.name;
            }
        });
        document.getElementById('do-unlock').addEventListener('click', async () => {
            if(!unlockFile) return alert('è«‹é¸æ“‡æª”æ¡ˆ');
            const pwd = document.getElementById('pass-unlock').value;
            try {
                // å˜—è©¦è®€å–ï¼Œå¦‚æœæœ‰å¯†ç¢¼å‰‡éœ€è¦å‚³å…¥
                // pdf-lib load æ™‚è‹¥æœ‰å¯†ç¢¼éœ€åœ¨ç¬¬äºŒåƒæ•¸
                const { PDFDocument } = PDFLib;
                // PDF-lib çš„è§£é–é‚è¼¯æ˜¯ï¼šå¦‚æœèƒ½å¤  load æˆåŠŸï¼Œsave æ™‚ä¸è¨­ encrypt å³å¯
                // ä½†å¦‚æœæª”æ¡ˆæœ‰å¯†ç¢¼ï¼Œload å¿…é ˆçµ¦å¯†ç¢¼ï¼Œå¦å‰‡æœƒå ±éŒ¯
                const arr = await unlockFile.arrayBuffer();
                let pdf;
                try {
                    pdf = await PDFDocument.load(arr, { password: pwd });
                } catch(err) {
                    if(err.message.includes('Password')) return alert('å¯†ç¢¼éŒ¯èª¤æˆ–æœªè¼¸å…¥');
                    throw err;
                }
                saveAs(new Blob([await pdf.save()], {type:'application/pdf'}), `unlocked_${unlockFile.name}`);
            } catch(e){ alert("Unlock Error: " + e.message); }
        });

        // 6. Rotate
        let rotateFile, rotateDeg=90;
        document.getElementById('file-rotate').addEventListener('change', e => {
            if(e.target.files[0]){
                rotateFile=e.target.files[0];
                document.getElementById('name-rotate').textContent=rotateFile.name;
                document.getElementById('ctrl-rotate').classList.remove('hidden');
            }
        });
        window.setRotate = d => {
            rotateDeg=d;
            document.querySelectorAll('.rotate-opt').forEach(b=>{
                const on = parseInt(b.dataset.deg)===d;
                b.className = on ? 'rotate-opt bg-blue-100 hover:bg-blue-200 py-2 rounded border border-blue-500 text-blue-700' : 'rotate-opt bg-gray-100 hover:bg-gray-200 py-2 rounded border border-gray-200';
            });
        };
        setRotate(90);
        document.getElementById('do-rotate').addEventListener('click', async () => {
            if(!rotateFile) return;
            try {
                const { PDFDocument, degrees } = PDFLib;
                const pdf = await PDFDocument.load(await rotateFile.arrayBuffer());
                pdf.getPages().forEach(p => p.setRotation(degrees(p.getRotation().angle + rotateDeg)));
                saveAs(new Blob([await pdf.save()],{type:'application/pdf'}), `rotated.pdf`);
            } catch(e){ alert(e.message); }
        });

        // 7. HEIC
        document.getElementById('file-heic').addEventListener('change', e => {
            const f=e.target.files[0]; if(!f) return;
            const area=document.getElementById('res-heic');
            area.classList.remove('hidden');
            document.getElementById('dl-heic').classList.add('hidden');
            document.getElementById('status-heic').textContent = translations[currentLang]['processing'];
            heic2any({blob:f, toType:"image/jpeg", quality:0.9}).then(blob=>{
                document.getElementById('preview-heic').src=URL.createObjectURL(blob);
                document.getElementById('status-heic').textContent="OK!";
                const btn=document.getElementById('dl-heic'); btn.classList.remove('hidden');
                btn.onclick=()=>saveAs(blob, f.name.replace(/\..+/,".jpg"));
            }).catch(e=>document.getElementById('status-heic').textContent="Error:"+e.message);
        });

        // 8. JPG/PNG to AI
        let toaiFile=null;
        document.getElementById('file-toai').addEventListener('change', e=>{
            if(e.target.files[0]){
                toaiFile=e.target.files[0];
                document.getElementById('name-toai').textContent=toaiFile.name;
                document.getElementById('ctrl-toai').classList.remove('hidden');
            }
        });
        document.getElementById('do-toai').addEventListener('click', async () => {
            if(!toaiFile) return;
            const btn=document.getElementById('do-toai'); btn.disabled=true; btn.textContent=translations[currentLang]['processing'];
            try {
                const { PDFDocument } = PDFLib;
                const pdf = await PDFDocument.create();
                const buf = await toaiFile.arrayBuffer();
                let img;
                if(toaiFile.type==='image/jpeg') img=await pdf.embedJpg(buf);
                else if(toaiFile.type==='image/png') img=await pdf.embedPng(buf);
                else return alert('Only JPG/PNG');
                const page = pdf.addPage([img.width, img.height]);
                page.drawImage(img, {x:0, y:0, width:img.width, height:img.height});
                saveAs(new Blob([await pdf.save()],{type:'application/pdf'}), toaiFile.name.replace(/\..+/,".ai"));
            } catch(e){ alert(e.message); }
            finally { btn.disabled=false; btn.textContent=translations[currentLang]['btn_toai_dl']; }
        });

    </script>
</body>
</html>